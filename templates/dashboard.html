<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>视频管理系统</title>
    <link href="/static/bootstrap.min.css" rel="stylesheet">
    <link href="/static/FontAwesome_all.min.css" rel="stylesheet">
    <script src="/static/chart.js"></script>
    <style>
        :root {
            --primary-blue: #1a73e8;
            --secondary-blue: #4285f4;
            --light-blue: #e8f0fe;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
        }

        .sidebar {
            width: 250px;
            height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            background-color: white;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
            z-index: 1000;
        }

        .main-content {
            margin-left: 250px;
            padding: 20px;
        }

        .nav-link {
            color: #333;
            padding: 15px 20px;
            transition: all 0.3s;
        }

        .nav-link:hover, .nav-link.active {
            background-color: var(--light-blue);
            color: var(--primary-blue);
        }

        .nav-link i {
            margin-right: 10px;
        }

        .card {
            border: none;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .upload-area {
            border: 2px dashed var(--primary-blue);
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            background-color: var(--light-blue);
            cursor: pointer;
        }


        .btn-primary {
            background-color: var(--primary-blue);
            border-color: var(--primary-blue);
        }

        .btn-primary:hover {
            background-color: var(--secondary-blue);
            border-color: var(--secondary-blue);
        }

        .video-player-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.8);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .video-player-container {
            width: 80vw;
            height: 80vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .video-container {
            width: 100%;
            height: calc(100% - 40px);
            position: relative;
        }


        .video-player-close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            color: white;
            font-size: 24px;
            cursor: pointer;
        }

        video {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .tab-pane {
            margin-top: 20px;
        }

        .truncate {
            max-width: 200px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: inline-block;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .spinner-border {
            width: 3rem;
            height: 3rem;
        }

        .stats-card {
            margin-bottom: 20px;
        }

        .wordcloud-container {
            max-width: 100%;
            height: auto;
            margin-top: 20px;
        }

        .wordcloud-image {
            max-width: 100%;
            height: auto;
        }

        .table th, .table td {
            white-space: nowrap;
            padding: 8px 16px;
        }

        .btn:disabled {
            cursor: not-allowed;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-item {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        /* ... 其他样式保持不变 ... */


        .stats-card {
            margin-bottom: 20px;
        }

        .wordcloud-container {
            max-width: 100%;
            height: auto;
            margin-top: 20px;
        }

        .wordcloud-image {
            max-width: 100%;
            height: auto;
        }

        .chart-image {
            max-width: 100%;
            height: auto;
            object-fit: cover; /* 确保图片裁剪 */
        }

        .card.h-100 {
            height: 100%; /* 确保卡片高度一致 */
        }

        .row {
            margin-right: -15px;
            margin-left: -15px;
        }

        .col-md-6 {
            padding-right: 15px;
            padding-left: 15px;
        }
    </style>
</head>
<body>
<div class="sidebar">
    <div class="p-3">
        <h4 class="text-center text-primary mb-4">视频管理系统</h4>
        <div class="nav flex-column">
            <a class="nav-link active" data-page="video-list" href="#">
                <i class="fas fa-video"></i> 视频管理
            </a>
            <a class="nav-link" data-page="video-upload" href="#">
                <i class="fas fa-upload"></i> 视频上传
            </a>
            <a class="nav-link" data-page="download-task" href="#">
                <i class="fas fa-download"></i> 下载任务
            </a>
            <a class="nav-link" data-page="statistics" href="#">
                <i class="fas fa-chart-pie"></i> 统计信息
            </a>
        </div>
    </div>
</div>

<div class="main-content">
    <!-- 视频列表 -->
    <div class="content-page" id="video-list">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title mb-4">视频列表</h5>
                <table class="table">
                    <thead>
                        <tr>
                            <th>标题</th>
                            <th>封面</th>
                            <th>播放量</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="video-table-body"></tbody>
                </table>
                <!-- 添加分页控件 -->
                <nav aria-label="Page navigation" style="margin-top: 20px;">
                    <ul class="pagination justify-content-center" id="pagination"></ul>
                </nav>
            </div>
        </div>
    </div>

    <!-- 视频上传 -->
    <div class="content-page" id="video-upload" style="display: none;">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title mb-4">视频上传</h5>
                <div class="upload-area" id="dropZone">
                    <i class="fas fa-cloud-upload-alt fa-3x text-primary mb-3"></i>
                    <h5>拖拽文件到这里或点击上传</h5>
                    <p class="text-muted">支持单个文件或文件夹上传</p>
                    <input id="fileInput" multiple style="display: none;" type="file">
                    <button class="btn btn-primary mt-3" onclick="document.getElementById('fileInput').click()">
                        选择文件
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 下载任务 -->
    <div class="content-page" id="download-task" style="display: none;">
        <div class="tab-content" id="myTabContent"></div>
        <div class="card mt-4">
            <div class="card-body">
                <h5 class="card-title mb-4">下载任务列表</h5>
                <button class="btn btn-primary mb-4" id="startDownloadTasksBtn">开始下载任务</button>
                <table class="table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>标题</th>
                            <th>URL</th>
                            <th>状态</th>
                        </tr>
                    </thead>
                    <tbody id="download-table-body"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- 系统统计信息 -->
    <div class="content-page" id="statistics" style="display: none;">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title mb-4">系统统计信息</h5>
                <div class="stats-grid">
                    <div class="stat-item">
                        <h6>视频总数</h6>
                        <p class="h3" id="videoCount">-</p>
                    </div>
                    <div class="stat-item">
                        <h6>存储空间使用</h6>
                        <p class="h3" id="storageUsed">-</p>
                    </div>
                    <div class="stat-item">
                        <h6>数据库创建时间</h6>
                        <p class="h3" id="dbCreatedDate">-</p>
                    </div>
                </div> <!-- 关闭 .stats-grid -->

                <div class="row mt-4">
                    <!-- 存储空间使用情况 -->
                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-body">
                                <h6 class="card-title">存储空间使用情况</h6>
                                <canvas id="storageChart"></canvas>
                            </div>
                        </div>
                    </div>
                    <!-- 系统资源使用情况及新增图表 -->
                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-body d-flex flex-column justify-content-between">
                                <!-- 系统资源使用情况 -->
                                <div class="mb-2">
                                    <h6 class="card-title">系统资源使用情况</h6>
                                    <div class="row">
                                        <div class="col-md-4">
                                            <div class="card">
                                                <div class="card-body">
                                                    <h6 class="card-title">磁盘写入</h6>
                                                    <p class="card-text" id="diskWriteCount">0 GB</p>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="card">
                                                <div class="card-body">
                                                    <h6 class="card-title">磁盘读取</h6>
                                                    <p class="card-text" id="diskReadCount">0 GB</p>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="card">
                                                <div class="card-body">
                                                    <h6 class="card-title">网络流出</h6>
                                                    <p class="card-text" id="networkOutCount">0 GB</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <!-- 新增图表 -->
                                <div>
                                    <div class="mb-2">
                                        <h6 class="card-title">网络使用</h6>
                                        <img src="http://192.168.1.113:8685/?2-s" alt="网络使用图" class="chart-image" id="networkUsageImage">
                                    </div>
                                    <div>
                                        <h6 class="card-title">小时使用</h6>
                                        <img src="http://192.168.1.113:8685/?2-hg" alt="小时使用图" class="chart-image" id="hourlyUsageImage">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div> <!-- 关闭 .row -->

                <!-- 标题词云 -->
                <div class="card mt-4">
                    <div class="card-body">
                        <h6 class="card-title">标题词云</h6>
                        <div class="wordcloud-container">
                            <img alt="词云图" class="wordcloud-image" id="wordcloudImage">
                        </div>
                    </div>
                </div>
            </div> <!-- 关闭 .card-body -->
        </div> <!-- 关闭 .card -->
    </div> <!-- 关闭 #statistics .content-page -->
</div> <!-- 关闭 .main-content -->
<!-- 加载动画 -->
<div class="loading-overlay" id="loadingOverlay" style="display: none;">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
</div>
<div class="video-player-overlay" id="videoPlayerOverlay" onclick="closeVideoPlayer()">
    <div class="video-player-container" onclick="event.stopPropagation()">
        <span class="video-player-close-btn" onclick="closeVideoPlayer()">&times;</span>
        <video controls id="videoPlayer"></video>
    </div>
</div>

<script src="/static/bootstrap.bundle.min.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        // 分页相关变量
        let currentPage = 1;
        const pageSize = 20;

        // 导航链接处理
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', function (e) {
                e.preventDefault();
                document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                this.classList.add('active');

                const targetPage = this.getAttribute('data-page');
                console.log(`目标页面: ${targetPage}`);

                document.querySelectorAll('.content-page').forEach(page => {
                    page.style.display = 'none';
                });

                const targetElement = document.getElementById(targetPage);
                if (targetElement) {
                    targetElement.style.display = 'block';
                    if (targetPage === 'statistics') {
                        loadStatistics();
                    } else if (targetPage === 'download-task') {
                        loadDownloadTasks();
                    }
                } else {
                    console.error(`找不到目标元素，ID为: ${targetPage}`);
                }
            });
        });

        // 修复问题1：创建pagination元素
        const downloadTaskPage = document.getElementById('download-task');
        if (!document.getElementById('download-pagination')) {
            const paginationNav = document.createElement('nav');
            paginationNav.setAttribute('aria-label', 'Page navigation');
            paginationNav.style.marginTop = '20px';
            const paginationUl = document.createElement('ul');
            paginationUl.className = 'pagination justify-content-center';
            paginationUl.id = 'download-pagination';
            paginationNav.appendChild(paginationUl);
            downloadTaskPage.querySelector('.card').appendChild(paginationNav);
        }

        // 开始下载任务按钮处理
        const startDownloadTasksBtn = document.getElementById('startDownloadTasksBtn');
        if (startDownloadTasksBtn) {
            startDownloadTasksBtn.addEventListener('click', function () {
                this.disabled = true;
                fetch('/api/download_all', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.code === 200) {
                            alert('下载成功');
                            loadDownloadTasks();
                        } else {
                            alert('启动失败');
                        }
                    })
                    .catch(error => {
                        console.error('启动下载任务失败:', error);
                        alert('启动下载任务失败，请重试');
                    })
                    .finally(() => {
                        this.disabled = false;
                    });
            });
        }

        // 视频播放功能
        window.playVideo = function (videoUrl) {
            const videoPlayer = document.getElementById('videoPlayer');
            const overlay = document.getElementById('videoPlayerOverlay');

            videoPlayer.src = videoUrl;
            videoPlayer.load();

            videoPlayer.onerror = function () {
                console.error('Video loading error:', videoPlayer.error);
                alert('视频加载失败，请检查视频地址是否正确');
            };

            videoPlayer.play().catch(function (error) {
                console.error('Video playback error:', error);
                alert('视频播放失败：' + error.message);
            });

            overlay.style.display = 'flex';
        };

        // 视频播放器关闭功能
        window.closeVideoPlayer = function () {
            const overlay = document.getElementById('videoPlayerOverlay');
            const videoPlayer = document.getElementById('videoPlayer');
            videoPlayer.pause();
            videoPlayer.removeAttribute('src'); // 修复问题3
            overlay.style.display = 'none';
        };

        // 删除视频功能
        window.deleteVideo = function (videoUrl) {
            if (confirm('确定要删除这个视频吗？')) {
                fetch('/api/manage/delete', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({url: videoUrl})
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.code === 200) {
                            alert('删除成功！');
                            loadVideos(currentPage);
                        } else {
                            alert(`删除失败：${data.message}`);
                        }
                    })
                    .catch(error => {
                        console.error('删除失败:', error);
                        alert('删除失败，请重试');
                    });
            }
        };

        // 分页功能
        function createPagination(totalPages, currentPage, elementId) {
            const pagination = document.getElementById(elementId);
            if (!pagination) return; // 防止空引用错误

            pagination.innerHTML = '';

            function addPageButton(page, text) {
                const li = document.createElement('li');
                li.className = `page-item ${page === currentPage ? 'active' : ''}`;
                li.innerHTML = `<a class="page-link" href="#" onclick="event.preventDefault(); loadPage('${elementId === 'download-pagination' ? 'download' : 'video'}', ${page})">${text}</a>`;
                pagination.appendChild(li);
            }

            // 添加页码按钮
            addPageButton(1, '1');

            if (currentPage > 3) {
                addPageButton(null, '...');
            }

            for (let i = Math.max(2, currentPage - 1); i <= Math.min(totalPages - 1, currentPage + 1); i++) {
                if (i <= currentPage + 1 && i >= currentPage - 1) {
                    addPageButton(i, i.toString());
                }
            }

            if (currentPage < totalPages - 2) {
                addPageButton(null, '...');
            }

            if (totalPages > 1) {
                addPageButton(totalPages, totalPages.toString());
            }
        }

        // 页面加载功能
        window.loadPage = function (type, page) {
            if (type === 'video') {
                loadVideos(page);
            } else if (type === 'download') {
                loadDownloadTasks(page);
            }
        }

        // 加载视频列表
        window.loadVideos = function (page) {
            currentPage = page;
            fetch(`/api/get_video_list?page=${page}&page_size=${pageSize}`)
                .then(response => response.json())
                .then(data => {
                    const tableBody = document.getElementById('video-table-body');
                    tableBody.innerHTML = '';

                    data.videos.forEach(video => {
                        const row = `
                        <tr>
                            <td class="truncate">${video.title}</td>
                            <td><img src="${video.cover}" alt="封面" style="height: 50px;"></td>
                            <td>${video.watch}</td>
                            <td>
                                <button class="btn btn-sm btn-primary" onclick="playVideo('${video.url}')">播放</button>
                                <button class="btn btn-sm btn-danger" onclick="deleteVideo('${video.url}')">删除</button>
                            </td>
                        </tr>
                    `;
                        tableBody.innerHTML += row;
                    });

                    const totalPages = Math.ceil(data.total / pageSize);
                    createPagination(totalPages, page, 'pagination');
                })
                .catch(error => {
                    console.error('获取视频列表失败:', error);
                });
        };

        // 加载下载任务列表
        window.loadDownloadTasks = function (page = 1) {
            fetch(`/api/download_status?page=${page}&count=${pageSize}`)
                .then(response => response.json())
                .then(data => {
                    const tableBody = document.getElementById('download-table-body');
                    tableBody.innerHTML = '';

                    data.downloads.forEach(task => {
                        let statusText = '';
                        let statusClass = '';
                        switch (task.status) {
                            case 0:
                                statusText = '等待下载';
                                statusClass = 'text-black';
                                break;
                            case 1:
                                statusText = '下载成功';
                                statusClass = 'text-success';
                                break;
                            case 2:
                                statusText = '下载失败';
                                statusClass = 'text-danger';
                                break;
                            case 3:
                                statusText = '正在下载';
                                statusClass = 'text-warning';
                                break;
                            default:
                                statusText = '未知状态';
                                statusClass = 'text-secondary';
                        }

                        const row = `
                        <tr>
                            <td>${task.id}</td>
                            <td class="truncate">${task.title}</td>
                            <td class="truncate">${task.url}</td>
                            <td class="${statusClass}">${statusText}</td>
                        </tr>
                    `;
                        tableBody.innerHTML += row;
                    });

                    const totalPages = Math.ceil(data.total / pageSize);
                    createPagination(totalPages, page, 'download-pagination');
                })
                .catch(error => {
                    console.error('获取下载任务状态失败:', error);
                });
        };

        // 加载统计信息
        function loadStatistics() {
            const loadingOverlay = document.getElementById('loadingOverlay');
            loadingOverlay.style.display = 'flex';

            fetch('/api/statistics', {
                method: 'GET', // 修改为 GET 请求
                headers: {
                    'Content-Type': 'application/json'
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.code === 200) {
                        // 更新基本信息
                        document.getElementById('videoCount').textContent = data.video_count;
                        // 检查 data.storage_space_used 是否为数字
                        if (typeof data.storage_space_used === 'number') {
                            // 将 MB 转换为 GB
                            const storageUsedGB = data.storage_space_used / 1024;
                            document.getElementById('storageUsed').textContent = `${storageUsedGB.toFixed(2)} GB`;
                        } else {
                            // 如果不是数字，尝试转换为数字
                            const storageUsedMB = parseFloat(data.storage_space_used);
                            if (!isNaN(storageUsedMB)) {
                                // 将 MB 转换为 GB
                                const storageUsedGB = storageUsedMB / 1024;
                                document.getElementById('storageUsed').textContent = `${storageUsedGB.toFixed(2)} GB`;
                            } else {
                                // 如果转换失败，设置默认值或错误信息
                                document.getElementById('storageUsed').textContent = 'N/A';
                                console.error('Invalid storage space used data:', data.storage_space_used);
                            }
                        }

                        document.getElementById('dbCreatedDate').textContent = new Date(data.database_created_date).toLocaleDateString();

                        // 存储空间饼图
                        const storageCtx = document.getElementById('storageChart').getContext('2d');
                        new Chart(storageCtx, {
                            type: 'pie',
                            data: {
                                labels: ['已使用空间', '可用空间'],
                                datasets: [{
                                    data: [data.storage_space_used_percent, 100 - data.storage_space_used_percent],
                                    backgroundColor: ['#4285f4', '#e8f0fe']
                                }]
                            },
                            options: {
                                responsive: true,
                                plugins: {
                                    legend: {
                                        position: 'bottom'
                                    }
                                }
                            }
                        });

                        // 移除系统资源柱状图，改为直接显示数字
                        document.getElementById('diskWriteCount').textContent = `${data.disk_write_count} GB`;
                        document.getElementById('diskReadCount').textContent = `${data.disk_read_count} GB`;
                        document.getElementById('networkOutCount').textContent = `${data.Network_out_count} GB`;

                        // 更新词云图
                        document.getElementById('wordcloudImage').src = data.wordcloud; // 假设 data.wordcloud 是相对路径
                    }
                })
                .catch(error => {
                    console.error('加载统计信息失败:', error);
                    alert('加载统计信息失败，请重试');
                })
                .finally(() => {
                    loadingOverlay.style.display = 'none';
                });

        }

        // 初始加载
        loadVideos(1);
    });
</script>
</body>
</html>